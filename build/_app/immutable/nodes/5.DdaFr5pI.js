import{a as D,t as C,b as be}from"../chunks/disclose-version.pAZcs84n.js";import{W as j,$ as A,X as W,R as ye,a1 as F,a4 as x,Y as s,a2 as ue,_ as I,a5 as te,O as ne,a3 as we,Z as d,a0 as z,aw as Ue}from"../chunks/utils.BRJKUTqf.js";import{s as J}from"../chunks/render.j7FqK5Uc.js";import{s as G,i as K,e as O,f as _e,d as ce,g as Ie}from"../chunks/store.BTSVGJLy.js";import{h as Fe}from"../chunks/svelte-head.Bh-irVxV.js";import{a as ie,p as L}from"../chunks/props.BlxC-9-v.js";import{b as Q}from"../chunks/this.BvguKOfU.js";import{o as xe}from"../chunks/index-client.DGISRjzp.js";import"../chunks/database.CtsHh3PR.js";import{s as Se,r as de,a as Be,c as ae,d as re,e as se,t as Le}from"../chunks/imageUtils.CboFgM1z.js";import{s as q}from"../chunks/store.2SISmz6u.js";import{t as P,b as oe}from"../chunks/input.IcoeKV5q.js";import{D as ze,P as Ze}from"../chunks/DragDropUpload.By2bqb05.js";import{b as $e}from"../chunks/paths.BXsdQ0-J.js";function De(e,t,n){return Math.max(Math.min(e,n),t)}var ke=C('<div data-form-stage="" class="svelte-1jweudo"><!></div>');function ee(e,t){j(t,!0);let n=ue(()=>t.stage!==t.currentStage);var i=ke(),a=F(i);Se(a,()=>t.children??ye),x(i),A(()=>P(i,"hidden",s(n))),D(e,i),W()}var Te=C('<p>To preview your uploaded image, click the <img alt="A document and a magnifying glass" style="height: 2em; width: 2em; display: inline; margin-left: 0.7ch; position: relative; top: 0.5em;"> icon on the left toolbar</p>'),Ce=C("<p>Drag and drop a .png image here, or click to upload a file.</p> <!>",1),Ae=C('<h1 class="svelte-1g4c4fn">Step 1: Insert Your Map Image</h1> <div class="file-upload-container svelte-1g4c4fn"><!></div>',1);function Me(e,t){j(t,!0);const n=G(),i=()=>O(q,"$store",n);let a=ie(t,"canGoToNextStage",15),o=ie(t,"disableAdvanceStageButtons",15);function f(){return p===null?"No uploaded image":!0}const m="StageOne";let p=null;function u(v){const r=new Blob([v]),c=URL.createObjectURL(r);o(!0);const l=new Image;l.onload=()=>{const b=l.width%8,U=l.height%8;de(l,{type:"additive",x:b,y:U}).then(_=>{p=_,i().mapImage!==null&&URL.revokeObjectURL(i().mapImage.src),_e(q,ne(i).mapImage=_,ne(i)),o(!1),a(f())}).catch(_=>{o(!1);const S=_ instanceof Error?_.message:"Unspecified error";throw new Error(`[${m} | uploadMapImage] | ${S}`)})},l.src=c}return ee(e,{stage:1,get currentStage(){return t.activeStage},children:(v,r)=>{var c=Ae(),l=I(te(c),2),b=F(l);ze(b,{onFileUpload:U=>{u(U[0])},validFileRegex:/.+\.png$/,mimeType:"image/png",children:(U,_)=>{var S=Ce(),B=I(te(S),2);{var g=y=>{var w=Te(),Z=I(F(w));Be(Z,"src",`${$e??""}/preview.png`),we(),x(w),D(y,w)};K(B,y=>{i().mapImage!==null&&y(g)})}D(U,S)},$$slots:{default:!0}}),x(l),D(v,c)},$$slots:{default:!0}}),W({isStageComplete:f})}var Ve=C('<div class="container svelte-8docdc"><h1 class="svelte-8docdc">Step 2: (Optional)</h1> <label for="tileWidth" class="svelte-8docdc">Tile Width: <input id="tileWidth" name="tileWidth" type="number" min="1" max="2000" step="1" class="svelte-8docdc"></label> <br> <label for="tileHeight" class="svelte-8docdc">Tile Height: <input id="tileHeight" name="tileHeight" type="number" min="1" max="2000" step="1" class="svelte-8docdc"></label></div>');function Ne(e,t){j(t,!0);const n=G(),i=()=>O(q,"$store",n);let a=null;function o(){return f(i().mapImage,s(p),s(u))}function f(r,c,l){if(c<1)return"Tile width must be greater than 1";if(l<1)return"Tile height must be greater than 1";if(!Number.isInteger(c))return"Tile width must be an integer";if(!Number.isInteger(l))return"Tile height must be an integer";if(c>2e3)return"Tile width must be less than 2000";if(l>2e3)return"Tile height must be less than 2000";if(r!==null){if(!Number.isInteger(r.width/c))return"Tile width does not produce an integer number of tiles";if(!Number.isInteger(r.height/l))return"Tile height does not produce an integer number of tiles"}return!0}function m(r){for(let c=1;c++;c<r){const l=r/c;if(Number.isInteger(l)&&l<2e3)return l}return 0}let p=z(1),u=z(1);q.subscribe(r=>{var b,U;if(a===r.mapImage)return;a=r.mapImage,d(p,L(r.mapImage===null?1:m(r.mapImage.width))),d(u,L(r.mapImage===null?1:m(r.mapImage.height)));const c=(((b=r.mapImage)==null?void 0:b.width)??0)/s(p),l=(((U=r.mapImage)==null?void 0:U.height)??0)/s(u);r.tilesX===c&&r.tilesY===l||(Number.isInteger(c)&&(r.tilesX=c),Number.isInteger(l)&&(r.tilesY=l))});let v=ue(()=>f(i().mapImage,s(p),s(u)));return ee(e,{stage:2,get currentStage(){return t.activeStage},children:(r,c)=>{var l=Ve(),b=I(F(l),2),U=I(F(b));ae(U),x(b);var _=I(b,4),S=I(F(_));ae(S),x(_),x(l),A(()=>{P(U,"invalid",typeof s(v)=="string"),P(S,"invalid",typeof s(v)=="string")}),oe(U,()=>s(p),B=>d(p,B)),oe(S,()=>s(u),B=>d(u,B)),D(r,l)},$$slots:{default:!0}}),W({isStageComplete:o})}"stream"in Blob.prototype||Object.defineProperty(Blob.prototype,"stream",{value(){return new Response(this).body}}),"setBigUint64"in DataView.prototype||Object.defineProperty(DataView.prototype,"setBigUint64",{value(e,t,n){const i=Number(0xffffffffn&t),a=Number(t>>32n);this.setUint32(e+(n?0:4),i,n),this.setUint32(e+(n?4:0),a,n)}});var Y=e=>new DataView(new ArrayBuffer(e)),k=e=>new Uint8Array(e.buffer||e),H=e=>new TextEncoder().encode(String(e)),M=e=>Math.min(4294967295,Number(e)),le=e=>Math.min(65535,Number(e));function He(e,t){if(t===void 0||t instanceof Date||(t=new Date(t)),e instanceof File)return{isFile:1,t:t||new Date(e.lastModified),i:e.stream()};if(e instanceof Response)return{isFile:1,t:t||new Date(e.headers.get("Last-Modified")||Date.now()),i:e.body};if(t===void 0)t=new Date;else if(isNaN(t))throw new Error("Invalid modification date.");if(e===void 0)return{isFile:0,t};if(typeof e=="string")return{isFile:1,t,i:H(e)};if(e instanceof Blob)return{isFile:1,t,i:e.stream()};if(e instanceof Uint8Array||e instanceof ReadableStream)return{isFile:1,t,i:e};if(e instanceof ArrayBuffer||ArrayBuffer.isView(e))return{isFile:1,t,i:k(e)};if(Symbol.asyncIterator in e)return{isFile:1,t,i:ge(e[Symbol.asyncIterator]())};throw new TypeError("Unsupported input format.")}function ge(e,t=e){return new ReadableStream({async pull(n){let i=0;for(;n.desiredSize>i;){const a=await e.next();if(!a.value){n.close();break}{const o=Ye(a.value);n.enqueue(o),i+=o.byteLength}}},cancel(n){var i;(i=t.throw)==null||i.call(t,n)}})}function Ye(e){return typeof e=="string"?H(e):e instanceof Uint8Array?e:k(e)}function me(e,t,n){let[i,a]=function(o){return o?o instanceof Uint8Array?[o,1]:ArrayBuffer.isView(o)||o instanceof ArrayBuffer?[k(o),1]:[H(o),0]:[void 0,0]}(t);if(e instanceof File)return{o:R(i||H(e.name)),u:BigInt(e.size),l:a};if(e instanceof Response){const o=e.headers.get("content-disposition"),f=o&&o.match(/;\s*filename\*?\s*=\s*(?:UTF-\d+''|)["']?([^;"'\r\n]*)["']?(?:;|$)/i),m=f&&f[1]||e.url&&new URL(e.url).pathname.split("/").findLast(Boolean),p=m&&decodeURIComponent(m),u=n||+e.headers.get("content-length");return{o:R(i||H(p)),u:BigInt(u),l:a}}return i=R(i,e!==void 0||n!==void 0),typeof e=="string"?{o:i,u:BigInt(H(e).length),l:a}:e instanceof Blob?{o:i,u:BigInt(e.size),l:a}:e instanceof ArrayBuffer||ArrayBuffer.isView(e)?{o:i,u:BigInt(e.byteLength),l:a}:{o:i,u:Xe(e,n),l:a}}function Xe(e,t){return t>-1?BigInt(t):e?void 0:0n}function R(e,t=1){if(!e||e.every(n=>n===47))throw new Error("The file must have a name.");if(t)for(;e[e.length-1]===47;)e=e.subarray(0,-1);else e[e.length-1]!==47&&(e=new Uint8Array([...e,47]));return e}var pe=new Uint32Array(256);for(let e=0;e<256;++e){let t=e;for(let n=0;n<8;++n)t=t>>>1^(1&t&&3988292384);pe[e]=t}function fe(e,t=0){t^=-1;for(var n=0,i=e.length;n<i;n++)t=t>>>8^pe[255&t^e[n]];return(-1^t)>>>0}function ve(e,t,n=0){const i=e.getSeconds()>>1|e.getMinutes()<<5|e.getHours()<<11,a=e.getDate()|e.getMonth()+1<<5|e.getFullYear()-1980<<9;t.setUint16(n,i,1),t.setUint16(n+2,a,1)}function qe({o:e,l:t},n){return 8*(!t||(n??function(i){try{je.decode(i)}catch{return 0}return 1}(e)))}var je=new TextDecoder("utf8",{fatal:1});function We(e,t=0){const n=Y(30);return n.setUint32(0,1347093252),n.setUint32(4,754976768|t),ve(e.t,n,10),n.setUint16(26,e.o.length,1),k(n)}async function*Ee(e){let{i:t}=e;if("then"in t&&(t=await t),t instanceof Uint8Array)yield t,e.m=fe(t,0),e.u=BigInt(t.length);else{e.u=0n;const n=t.getReader();for(;;){const{value:i,done:a}=await n.read();if(a)break;e.m=fe(i,e.m),e.u+=BigInt(i.length),yield i}}}function Je(e,t){const n=Y(16+(t?8:0));return n.setUint32(0,1347094280),n.setUint32(4,e.isFile?e.m:0,1),t?(n.setBigUint64(8,e.u,1),n.setBigUint64(16,e.u,1)):(n.setUint32(8,M(e.u),1),n.setUint32(12,M(e.u),1)),k(n)}function Qe(e,t,n=0,i=0){const a=Y(46);return a.setUint32(0,1347092738),a.setUint32(4,755182848),a.setUint16(8,2048|n),ve(e.t,a,12),a.setUint32(16,e.isFile?e.m:0,1),a.setUint32(20,M(e.u),1),a.setUint32(24,M(e.u),1),a.setUint16(28,e.o.length,1),a.setUint16(30,i,1),a.setUint16(40,e.isFile?33204:16893,1),a.setUint32(42,M(t),1),k(a)}function Re(e,t,n){const i=Y(n);return i.setUint16(0,1,1),i.setUint16(2,n-4,1),16&n&&(i.setBigUint64(4,e.u,1),i.setBigUint64(12,e.u,1)),i.setBigUint64(n-8,t,1),k(i)}function he(e){return e instanceof File||e instanceof Response?[[e],[e]]:[[e.input,e.name,e.size],[e.input,e.lastModified]]}var Pe=e=>function(t){let n=BigInt(22),i=0n,a=0;for(const o of t){if(!o.o)throw new Error("Every file must have a non-empty name.");if(o.u===void 0)throw new Error(`Missing size for file "${new TextDecoder().decode(o.o)}".`);const f=o.u>=0xffffffffn,m=i>=0xffffffffn;i+=BigInt(46+o.o.length+(f&&8))+o.u,n+=BigInt(o.o.length+46+(12*m|28*f)),a||(a=f)}return(a||i>=0xffffffffn)&&(n+=BigInt(76)),n+i}(function*(t){for(const n of t)yield me(...he(n)[0])}(e));function E(e,t={}){const n={"Content-Type":"application/zip","Content-Disposition":"attachment"};return(typeof t.length=="bigint"||Number.isInteger(t.length))&&t.length>0&&(n["Content-Length"]=String(t.length)),t.metadata&&(n["Content-Length"]=String(Pe(t.metadata))),new Response(Ge(e,t),{headers:n})}function Ge(e,t={}){const n=function(i){var o;const a=i[Symbol.iterator in i?Symbol.iterator:Symbol.asyncIterator]();return{async next(){const f=await a.next();if(f.done)return f;const[m,p]=he(f.value);return{done:0,value:Object.assign(He(...p),me(...m))}},throw:(o=a.throw)==null?void 0:o.bind(a),[Symbol.asyncIterator](){return this}}}(e);return ge(async function*(i,a){const o=[];let f=0n,m=0n,p=0;for await(const r of i){const c=qe(r,a.buffersAreUTF8);yield We(r,c),yield new Uint8Array(r.o),r.isFile&&(yield*Ee(r));const l=r.u>=0xffffffffn,b=12*(f>=0xffffffffn)|28*l;yield Je(r,l),o.push(Qe(r,f,c,b)),o.push(r.o),b&&o.push(Re(r,f,b)),l&&(f+=8n),m++,f+=BigInt(46+r.o.length)+r.u,p||(p=l)}let u=0n;for(const r of o)yield r,u+=BigInt(r.length);if(p||f>=0xffffffffn){const r=Y(76);r.setUint32(0,1347094022),r.setBigUint64(4,BigInt(44),1),r.setUint32(12,755182848),r.setBigUint64(24,m,1),r.setBigUint64(32,m,1),r.setBigUint64(40,u,1),r.setBigUint64(48,f,1),r.setUint32(56,1347094023),r.setBigUint64(64,f+u,1),r.setUint32(72,1,1),yield k(r)}const v=Y(22);v.setUint32(0,1347093766),v.setUint16(8,le(m),1),v.setUint16(10,le(m),1),v.setUint32(12,M(u),1),v.setUint32(16,M(f),1),yield k(v)}(n,t),n)}async function Ke(e,t,n,i,a,o,f){if(s(t)===void 0)return;if(d(n,""),d(i,""),s(t).set(0),a().mapImage===null){d(n,"No map image has been uploaded");return}d(i,"Resizing map image to half-size");const m=await de(a().mapImage,{type:"scale",x:.5,y:.5});s(t).set(o.RESIZE),d(i,`Splitting full size map into tiles (0 / ${a().tilesX*a().tilesY})`);const p=await re(a().mapImage,a().tilesX,a().tilesY,(g,y,w)=>{d(i,`Splitting full size map into tiles (${y} / ${w})`),s(t)!==void 0&&s(t).set(g*(o.SPLIT_FULL_SIZE-o.RESIZE)+o.RESIZE)});d(i,`Splitting half size map into tiles (0 / ${a().tilesX*a().tilesY})`);const u=await re(m,a().tilesX,a().tilesY,(g,y,w)=>{d(i,`Splitting half size map into tiles (${y} / ${w})`),s(t)!==void 0&&s(t).set(g*(o.SPLIT_HALF_SIZE-o.SPLIT_FULL_SIZE)+o.SPLIT_FULL_SIZE)});d(i,`Converting full size tiles into .basis files (0 / ${p.length})`);const v=await se(p.map(g=>{const{x:y,y:w,image:Z}=g;return{name:`tile_${y}_${w}@1x.basis`,image:Z}}),2,(g,y,w)=>{d(i,`Converting full size tiles into .basis files (${y} / ${w})`),s(t)!==void 0&&s(t).set(g*(o.CONVERT_FULL_SIZE-o.SPLIT_HALF_SIZE)+o.SPLIT_HALF_SIZE)});d(i,`Converting half size tiles into .basis files (0 / ${u.length})`);const r=await se(u.map(g=>{const{x:y,y:w,image:Z}=g;return{name:`tile_${y}_${w}@0.5x.basis`,image:Z}}),2,(g,y,w)=>{d(i,`Converting half size tiles into .basis files (${y} / ${w})`),s(t)!==void 0&&s(t).set(g*(o.CONVERT_HALF_SIZE-o.CONVERT_FULL_SIZE)+o.CONVERT_FULL_SIZE)}),c=v.map(g=>new File([g.file],g.name)),l=r.map(g=>new File([g.file],g.name)),b=(await Promise.all(p.map(async({x:g,y,image:w})=>({file:await Le(w),name:`tile_${g}_${y}@1x.png`})))).map(g=>new File([g.file],g.name));d(i,"Zipping files");const[U,_,S]=await Promise.all([E(c).blob(),E(l).blob(),E(b).blob()]),B=await E([{name:"1xBasis.zip",input:U},{name:"0.5xBasis.zip",input:_},{name:"PNGs.zip",input:S}]).blob();d(f,L(URL.createObjectURL(B))),d(i,"Done!"),s(t).set(o.ZIP)}var Oe=C('<span class="error svelte-1qx3arc"> </span>'),et=C('<div class="container svelte-1qx3arc"><h1 class="svelte-1qx3arc">Step 3: Convert and Download Files</h1> <p class="progress-bar-status svelte-1qx3arc"> <br> </p> <div class="progress-bar svelte-1qx3arc"><!></div> <div><button class="svelte-1qx3arc">Convert</button> <button class="svelte-1qx3arc">Download</button></div> <!></div>');function tt(e,t){j(t,!0);const n=G(),i=()=>O(q,"$store",n);let a=z(void 0),o=z(""),f=z(""),m=z("");const p={RESIZE:.05,SPLIT_FULL_SIZE:.075,SPLIT_HALF_SIZE:.1,CONVERT_FULL_SIZE:.65,CONVERT_HALF_SIZE:.95,ZIP:1};function u(){const v=document.createElement("a");v.href=s(m),v.download="bgTiles.zip",v.click()}ee(e,{get currentStage(){return t.activeStage},stage:3,children:(v,r)=>{var c=et(),l=I(F(c),2),b=F(l);A(()=>{var $;return J(b,`${(((($=s(a))==null?void 0:$.value)??0)*100).toFixed(2)??""}% `)});var U=I(b,2);x(l);var _=I(l,2),S=F(_);Q(Ze(S,{ariaLabel:"File Conversion Progress"}),$=>d(a,L($)),()=>s(a)),x(_);var B=I(_,2),g=F(B);g.__click=[Ke,a,o,f,i,p,m];var y=I(g,2);y.__click=u,x(B);var w=I(B,2);{var Z=$=>{var V=Oe(),h=F(V,!0);x(V),A(()=>J(h,s(o))),D($,V)};K(w,$=>{s(o)!==""&&$(Z)})}x(c),A(()=>{J(U,` ${s(f)??""}`),y.disabled=s(m)===""}),D(v,c)},$$slots:{default:!0}}),W()}ce(["click"]);var nt=(e,t,n)=>{t(e),n("back")},it=(e,t,n)=>{t(e),n("forward")},at=C('<div class="form-container svelte-193116m"><form class="scrolling-form" name="fileGeneratorForm" id="fileGeneratorForm"><!> <!> <!> <div class="submit svelte-193116m"><div class="error svelte-193116m"><!></div> <div class="submit-button-container svelte-193116m"><button data-direction="back" class="svelte-193116m">Back</button> <button data-direction="forward" class="svelte-193116m">Next</button></div></div></form></div>');function wt(e,t){var V;j(t,!0);const n={};let i=z(void 0),a=z(1),o=z(1),f=z(!1),m=z(void 0),p=z(void 0),u=z(L(((V=n[s(a)])==null?void 0:V.call(n))??!0));function v(h){var T,X;d(u,L(((T=n[s(a)])==null?void 0:T.call(n))??!0)),typeof s(u)!="string"&&(d(a,L(De(s(a)+(h==="back"?-1:1),1,s(o)))),d(u,L(((X=n[s(a)])==null?void 0:X.call(n))??!0)))}function r(h){h.preventDefault()}xe(()=>{var X;if(s(i)===void 0||s(m)===void 0||s(p)===void 0)return;const h=[...s(i).children].filter(N=>N.getAttribute("data-form-stage")!==null);let T=h.length;d(o,L(T));for(let N=0;N<T;N++)h[N].setAttribute("data-stage",N.toString());n[1]=s(m).isStageComplete,n[2]=s(p).isStageComplete,d(u,L(((X=n[s(a)])==null?void 0:X.call(n))??!0))});var c=at();Fe(h=>{Ue.title="File Generator"});var l=F(c),b=F(l);Q(Me(b,{get activeStage(){return s(a)},get canGoToNextStage(){return s(u)},set canGoToNextStage(h){d(u,L(h))},get disableAdvanceStageButtons(){return s(f)},set disableAdvanceStageButtons(h){d(f,L(h))}}),h=>d(m,L(h)),()=>s(m));var U=I(b,2);Q(Ne(U,{get activeStage(){return s(a)}}),h=>d(p,L(h)),()=>s(p));var _=I(U,2);tt(_,{get activeStage(){return s(a)}});var S=I(_,2),B=F(S),g=F(B);{var y=h=>{var T=be();A(()=>J(T,s(u))),D(h,T)};K(g,h=>{typeof s(u)=="string"&&h(y)})}x(B);var w=I(B,2),Z=F(w);Z.__click=[nt,r,v];var $=I(Z,2);$.__click=[it,r,v],x(w),x(S),x(l),Q(l,h=>d(i,h),()=>s(i)),x(c),A(()=>{Z.disabled=s(f)||s(a)===1||typeof s(u)=="string"&&!0,$.disabled=s(f)||s(a)===s(o)||typeof s(u)=="string"&&!0}),Ie("submit",l,r),D(e,c),W()}ce(["click"]);export{wt as component};
